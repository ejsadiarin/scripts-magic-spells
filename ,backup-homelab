#!/usr/bin/env bash

# Backup process:
# 1. Prepare services (database dumps, etc.)
# 2. Backup directly to Backblaze B2 via Restic (no intermediate local copy)

set -e

# --- Configuration ---
NTFY_ENDPOINT="https://ntfy.local.ejsadiarin.com/backups"
SERVICES_DIR="$HOME/services"

# Service Paths
TRAEFIK="$SERVICES_DIR/traefik"
AUTHENTIK="$SERVICES_DIR/authentik"
IMMICH="$SERVICES_DIR/immich"
PORTAINER="$SERVICES_DIR/portainer"
GITEA="$SERVICES_DIR/gitea"
NTFY="$SERVICES_DIR/ntfy"
UPTIME_KUMA="$SERVICES_DIR/uptime_kuma"
GLANCE="$SERVICES_DIR/glance"
BESZEL="$SERVICES_DIR/beszel"
CONSUMET="$SERVICES_DIR/consumet"
RESTIC_CONFIG="$SERVICES_DIR/restic"
VAULT="$HOME/vault"

# Active Backup Targets
# Comment/Uncomment services to enable/disable backup
TARGETS=(
    "$TRAEFIK"
    # "$AUTHENTIK"
    # "$PORTAINER"
    "$GITEA"
    "$NTFY"
    "$GLANCE"
    # "$BESZEL"
    # "$UPTIME_KUMA"
    "$IMMICH"
    "$RESTIC_CONFIG"
    "$VAULT"
    # "$CONSUMET"
)

# --- Functions ---

# Helper to check if a service is enabled in TARGETS
should_backup() {
    local search="$1"
    for t in "${TARGETS[@]}"; do
        if [[ "$t" == "$search" ]]; then
            return 0
        fi
    done
    return 1
}

# Notify via Ntfy
notify() {
    local title="$1"
    local message="$2"
    curl -X POST -H "Title: $title" -d "$message" "$NTFY_ENDPOINT" >/dev/null 2>&1 || true
}

# Prepare services (Dumps, etc.)
prepare_backups() {
    echo "--- Preparing Backups ---"

    # Authentik: Dump Postgres
    if should_backup "$AUTHENTIK"; then
        echo "Preparing Authentik..."
        mkdir -p "$AUTHENTIK/backups"
        # Overwrite 'postgres-backup.sql' to avoid local accumulation (Restic handles history)
        if docker exec -i authentik-postgres /usr/local/bin/pg_dump --username authentik-pg-admin authentik-pg-db >"$AUTHENTIK/backups/postgres-backup.sql"; then
            echo "[SUCCESS] Authentik DB dumped."
        else
            echo "[ERROR] Error dumping Authentik DB."
            return 1
        fi
    fi

    # Gitea: Dump (if enabled)
    if should_backup "$GITEA"; then
        echo "Preparing Gitea..."
        mkdir -p "$GITEA/backups"
        # Find gitea container
        GITEA_CONTAINER=$(docker ps -qf 'name=^gitea-server$')
        if [[ -n "$GITEA_CONTAINER" ]]; then
            # Run dump inside container
            docker exec -u git -w /tmp "$GITEA_CONTAINER" bash -c '/usr/local/bin/gitea dump -c /data/gitea/conf/app.ini'
            # Get filename
            LATEST_ZIP=$(docker exec -u git "$GITEA_CONTAINER" ls /tmp -Art | tail -n 1 | tr -d '\r')
            if [[ -n "$LATEST_ZIP" ]]; then
                # Copy out
                docker cp "$GITEA_CONTAINER":/tmp/"$LATEST_ZIP" "$GITEA/backups/"
                # Cleanup inside container
                docker exec -u git "$GITEA_CONTAINER" rm /tmp/"$LATEST_ZIP"
                # Prune old local dumps (keep last 3)
                (cd "$GITEA/backups" && ls -t | tail -n +4 | xargs -I {} rm -- {}) 2>/dev/null || true
                echo "[SUCCESS] Gitea dumped: $LATEST_ZIP"
            else
                echo "[ERROR] Gitea dump file not found."
            fi
        else
            echo "[WARN] Gitea container not found."
        fi
    fi

    # Immich: (Auto-backups handled by Immich/Postgres config, we just backup the dirs)
}

# Perform Restic Backup
perform_backup() {
    local DRY_RUN_FLAG=""
    if [[ "$1" == "--dry-run" ]]; then
        DRY_RUN_FLAG="--dry-run"
        echo "--- Starting Restic Backup (DRY RUN) ---"
    else
        echo "--- Starting Restic Backup ---"
    fi

    # Load Restic Env
    RESTIC_ENV="$RESTIC_CONFIG/restic-env"
    if [[ -f "$RESTIC_ENV" ]]; then
        source "$RESTIC_ENV"
    else
        echo "[ERROR] Restic env file not found: $RESTIC_ENV"
        exit 1
    fi

    # Build Excludes
    EXCLUDES=()

    # Gitea: exclude data and raw db (rely on dump)
    EXCLUDES+=("--exclude" "$GITEA/data")
    EXCLUDES+=("--exclude" "$GITEA/gitea-db")

    # Immich: exclude raw postgres (rely on auto-backups/dumps)
    EXCLUDES+=("--exclude" "$IMMICH/postgres")

    # Run Restic
    # sudo -E preserves the sourced environment variables (RESTIC_PASSWORD, etc.)
    if sudo -E restic backup $DRY_RUN_FLAG "${TARGETS[@]}" "${EXCLUDES[@]}"; then
        echo "[SUCCESS] Restic backup successful."
        if [[ -z "$DRY_RUN_FLAG" ]]; then
            echo "--- Checking Integrity ---"
            sudo -E restic check
        fi
    else
        echo "[FAILED] Restic backup failed."
        return 1
    fi
}

# --- Main ---

if [[ "$1" == "--dry-run" ]]; then
    echo "[DRY-RUN] Mode"
    perform_backup --dry-run
    notify "ðŸŸ¡ [DRY-RUN] Backup Complete" "Restic dry-run finished."

else
    # Real run
    if prepare_backups; then
        if perform_backup; then
            echo "Successfully finished backing up!"
            notify "ðŸŸ¢ [SUCCESS] Homelab Backup" "Finished updating offsite backups (snapshots)"
        else
            echo "Failed backup phase."
            notify "ðŸ”´ [FAILED] Homelab Backup" "Restic backup failed."
            exit 1
        fi
    else
        echo "Failed prepare phase."
        notify "ðŸ”´ [FAILED] Homelab Backup" "Preparation (DB dumps) failed."
        exit 1
    fi
fi
